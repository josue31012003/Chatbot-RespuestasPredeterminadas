<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Agente Virtual de Seguridad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --navy:#0b2b4a;
      --navy-2:#0a355d;
      --steel:#1f2a37;
      --slate:#334155;
      --bg:#eef3f7;
      --card:#ffffff;
      --soft:#f6f8fb;
      --line:#d9e2ec;
      --bot:#e8edf4;
      --user:#0b2b4a;
      --userText:#ffffff;
      --accent:#f59e0b; /* ámbar/seguridad */
      --accent2:#fbbf24;
    }

    *{ box-sizing:border-box; font-family:"Segoe UI", Tahoma, sans-serif; }

    body{
      margin:0;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(245,158,11,0.10), transparent 50%),
                  radial-gradient(900px 500px at 100% 20%, rgba(11,43,74,0.14), transparent 55%),
                  var(--bg);
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:16px;
    }

    .app{
      width:100%;
      max-width:760px;
      height:min(92vh, 840px);
      background:var(--card);
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,0.06);
      box-shadow:0 14px 40px rgba(0,0,0,0.12);
      display:flex;
      flex-direction:column;
    }

    .header{
      background: linear-gradient(135deg, var(--navy), var(--navy-2));
      color:white;
      padding:16px 18px;
      display:flex;
      align-items:center;
      gap:12px;
      position:relative;
    }

    .brand-mark{
      width:40px; height:40px;
      border-radius:12px;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.18);
      font-size:18px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      line-height:1.15;
    }
    .brand strong{ font-size:16px; letter-spacing:0.2px; }
    .brand small{ font-size:12px; opacity:0.88; margin-top:4px; }

    .header::after{
      content:"";
      position:absolute;
      right:-80px;
      top:-120px;
      width:260px; height:260px;
      border-radius:50%;
      background: radial-gradient(circle at 35% 35%, rgba(245,158,11,0.35), rgba(245,158,11,0.06), transparent 65%);
      pointer-events:none;
    }

    .content{
      flex:1;
      background:var(--soft);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .chat{
      flex:1;
      padding:16px;
      overflow-y:auto;
    }

    .row{ display:flex; margin-bottom:12px; }
    .row.bot{ justify-content:flex-start; }
    .row.user{ justify-content:flex-end; }

    .bubble{
      max-width:84%;
      padding:10px 12px;
      border-radius:14px;
      font-size:14px;
      line-height:1.35;
      white-space:pre-wrap;
      word-wrap:break-word;
      border:1px solid rgba(0,0,0,0.05);
    }

    .bot .bubble{
      background:var(--bot);
      color:#111827;
      border-bottom-left-radius:7px;
    }
    .user .bubble{
      background:var(--user);
      color:var(--userText);
      border-bottom-right-radius:7px;
      border-color: rgba(255,255,255,0.12);
    }

    .meta{
      font-size:11px;
      opacity:0.75;
      margin-top:6px;
    }

    .panel{
      background:var(--card);
      border-top:1px solid var(--line);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .menu-card{
      background: #fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .menu-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:12px;
      color:var(--slate);
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(245,158,11,0.35);
      background: rgba(245,158,11,0.10);
      color:#7c5200;
      font-weight:700;
      font-size:12px;
      white-space:nowrap;
    }

    .menu{
      font-size:13px;
      color:#0f172a;
      line-height:1.35;
      white-space:pre-wrap;
    }

    .input-row{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .input-row input{
      flex:1;
      padding:12px 14px;
      border-radius:999px;
      border:1px solid #cfd8e3;
      outline:none;
      font-size:14px;
      background:#fbfdff;
    }
    .input-row input:focus{
      border-color: rgba(245,158,11,0.85);
      box-shadow:0 0 0 3px rgba(245,158,11,0.18);
    }
    .input-row button{
      padding:12px 16px;
      border-radius:999px;
      border:none;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#1f2937;
      font-weight:800;
      cursor:pointer;
      transition: transform 0.06s ease, opacity 0.2s ease;
      white-space:nowrap;
    }
    .input-row button:active{ transform:scale(0.99); }
    .input-row button:disabled{ opacity:0.65; cursor:not-allowed; }

    .quick-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .qa{
      border:1px solid var(--line);
      background:#f8fafc;
      color:#0f172a;
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    .qa:hover{ border-color: rgba(11,43,74,0.45); }
  </style>
</head>

<body>
  <div class="app">
    <div class="header">
      <div class="brand-mark">⛏️</div>
      <div class="brand">
        <strong>Agente Virtual de Seguridad</strong>
        <small>Guía SST • Operación minera</small>
      </div>
    </div>

    <div class="content">
      <div class="chat" id="chat"></div>

      <div class="panel">
        <div class="menu-card">
          <div class="menu-title">
            <span>Opciones disponibles</span>
            <span class="chip">Escribe 1–9 o una palabra clave</span>
          </div>
          <div class="menu" id="menu"></div>
        </div>

        <div class="quick-actions">
          <button class="qa" onclick="goHome()">Inicio</button>
          <button class="qa" onclick="goBack()">Volver</button>
          <button class="qa" onclick="jumpTo('contactos')">Contactos</button>
          <button class="qa" onclick="jumpTo('glosario')">Glosario</button>
        </div>

        <div class="input-row">
          <input id="input" placeholder="Escribe tu opción o consulta (ej. 1, iperc, petar, loto)..." autocomplete="off" />
          <button id="sendBtn" onclick="send()">Enviar</button>
        </div>
      </div>
    </div>
  </div>

<script>
  // =========================
  // 1) Contenido (base de conocimiento)
  // =========================
  // Estructura: cada nodo tiene:
  // - bot: texto del bot
  // - options: lista de {key, label, next} (key es número o palabra)
  // - keywords: palabras clave -> next
  const KB = {
    home: {
      bot:
`Hola, soy tu agente virtual de seguridad.
Para empezar, elige un tema escribiendo el número o una palabra clave.`,
      options: [
        { key: "1", label: "IPERC (Identificación de Peligros, Evaluación de Riesgos y Controles)", next: "iperc" },
        { key: "2", label: "PETS / Procedimientos y estándares de trabajo seguro", next: "petsa" },
        { key: "3", label: "ATS / AST (Análisis Seguro de Trabajo)", next: "ats" },
        { key: "4", label: "Peligros vs Riesgos (conceptos + ejemplos)", next: "peligros" },
        { key: "5", label: "EPP (selección, uso, checklist)", next: "epp" },
        { key: "6", label: "Alto riesgo (PETAR, controles críticos)", next: "alto_riesgo" },
        { key: "7", label: "LOTO (bloqueo y etiquetado)", next: "loto" },
        { key: "8", label: "Incidentes y reporte (qué hacer)", next: "incidentes" },
        { key: "9", label: "Contactos de emergencia", next: "contactos" }
      ],
      keywords: {
        "iperc": "iperc",
        "petsa": "petsa", "pets": "petsa",
        "ats": "ats", "ast": "ats",
        "peligro": "peligros", "peligros": "peligros", "riesgo": "peligros", "riesgos": "peligros",
        "epp": "epp",
        "petar": "alto_riesgo", "alto riesgo": "alto_riesgo",
        "loto": "loto", "bloqueo": "loto", "etiquetado": "loto",
        "incidente": "incidentes", "incidentes": "incidentes", "reporte": "incidentes",
        "contacto": "contactos", "contactos": "contactos", "emergencia": "contactos",
        "glosario": "glosario"
      }
    },

    iperc: {
      bot:
`IPERC: Identificación de Peligros, Evaluación de Riesgos y Controles.
Se usa para reconocer peligros, estimar el nivel de riesgo y definir controles antes y durante la tarea.

Escribe una opción:`,
      options: [
        { key: "1", label: "IPERC Base vs IPERC Continuo", next: "iperc_base_continuo" },
        { key: "2", label: "Pasos para hacer un IPERC (rápido)", next: "iperc_pasos" },
        { key: "3", label: "Checklist IPERC en campo", next: "iperc_checklist" },
        { key: "4", label: "Volver al menú principal", next: "home" }
      ],
      keywords: { "base": "iperc_base_continuo", "continuo": "iperc_base_continuo", "pasos": "iperc_pasos", "checklist": "iperc_checklist", "inicio": "home" }
    },

    iperc_base_continuo: {
      bot:
`IPERC Base:
• Matriz estándar del área/tarea (peligros típicos + controles definidos).
• Se usa para planificar y entrenar.

IPERC Continuo (campo):
• Se realiza antes y durante la tarea.
• Se actualiza si cambian condiciones (clima, interferencias, energía, entorno, equipo, etc.).

Regla práctica: si cambia el escenario → reevalúa y ajusta controles.`,
      options: [
        { key: "1", label: "Volver a IPERC", next: "iperc" },
        { key: "2", label: "Menú principal", next: "home" }
      ],
      keywords: { "iperc": "iperc", "inicio": "home" }
    },

    iperc_pasos: {
      bot:
`Pasos rápidos para un IPERC:
1) Define tarea y alcance (qué, dónde, con qué equipo).
2) Identifica peligros por etapa (preparación, ejecución, cierre).
3) Evalúa el riesgo según la matriz aplicable.
4) Define controles usando jerarquía (no empezar por EPP).
5) Asigna responsables y verificación.
6) Comunica al equipo (briefing).
7) Si hay cambios: detener, reevaluar y actualizar.`,
      options: [
        { key: "1", label: "Checklist de campo", next: "iperc_checklist" },
        { key: "2", label: "Volver a IPERC", next: "iperc" },
        { key: "3", label: "Menú principal", next: "home" }
      ],
      keywords: { "checklist": "iperc_checklist", "iperc": "iperc", "inicio": "home" }
    },

    iperc_checklist: {
      bot:
`Checklist IPERC (campo):
□ Área señalizada / control de acceso
□ Interferencias identificadas (vehículos, equipos, líneas energizadas)
□ Condiciones ambientales (lluvia, viento, tormenta eléctrica, polvo)
□ Energías peligrosas identificadas (eléctrica, neumática, hidráulica, gravedad)
□ Herramientas/equipos inspeccionados
□ Permisos aplicables listos (si corresponde)
□ Controles críticos implementados (barandas, líneas de vida, bloqueo, etc.)
□ EPP correcto y en buen estado
□ Plan de comunicación/emergencia definido

Si hay un “NO” crítico → detener y corregir antes de continuar.`,
      options: [
        { key: "1", label: "Volver a IPERC", next: "iperc" },
        { key: "2", label: "Menú principal", next: "home" }
      ],
      keywords: { "iperc": "iperc", "inicio": "home" }
    },

    petsa: {
      bot:
`PETS: Procedimientos Escritos de Trabajo Seguro.
Establecen la forma segura y estandarizada de ejecutar tareas. Ayudan a reducir variabilidad y errores.

Escribe una opción:`,
      options: [
        { key: "1", label: "Cómo usar un PETS antes de una tarea", next: "petsa_uso" },
        { key: "2", label: "Checklist de cumplimiento PETS", next: "petsa_checklist" },
        { key: "3", label: "Menú principal", next: "home" }
      ],
      keywords: { "usar": "petsa_uso", "checklist": "petsa_checklist", "inicio": "home" }
    },

    petsa_uso: {
      bot:
`Cómo usar un PETS:
1) Verifica alcance (qué cubre / qué no).
2) Confirma herramientas/equipos requeridos.
3) Identifica controles obligatorios (barreras críticas).
4) Valida competencias/autorizaciones.
5) Complementa con IPERC/ATS si el escenario cambia o es no rutinario.
6) Briefing al equipo y roles claros.`,
      options: [
        { key: "1", label: "Checklist PETS", next: "petsa_checklist" },
        { key: "2", label: "Volver a PETS", next: "petsa" },
        { key: "3", label: "Menú principal", next: "home" }
      ],
      keywords: { "checklist": "petsa_checklist", "pets": "petsa", "petsa": "petsa", "inicio": "home" }
    },

    petsa_checklist: {
      bot:
`Checklist PETS:
□ La tarea coincide con el alcance del PETS
□ Versión vigente / documento aplicable
□ Controles críticos implementados antes de iniciar
□ Equipos/herramientas inspeccionados
□ Personal competente (autorización/certificación)
□ Señalización y control de área
□ Plan de respuesta ante emergencias definido`,
      options: [
        { key: "1", label: "Volver a PETS", next: "petsa" },
        { key: "2", label: "Menú principal", next: "home" }
      ],
      keywords: { "petsa": "petsa", "inicio": "home" }
    },

    ats: {
      bot:
`ATS/AST: Análisis Seguro de Trabajo.
Descompone una tarea en pasos, identifica peligros por paso y define controles.

Escribe una opción:`,
      options: [
        { key: "1", label: "Estructura recomendada de ATS", next: "ats_estructura" },
        { key: "2", label: "Ejemplo (formato) de ATS", next: "ats_ejemplo" },
        { key: "3", label: "Menú principal", next: "home" }
      ],
      keywords: { "estructura": "ats_estructura", "ejemplo": "ats_ejemplo", "inicio": "home" }
    },

    ats_estructura: {
      bot:
`Estructura sugerida de ATS:
1) Tarea y alcance
2) Pasos de la tarea
3) Peligros por paso
4) Controles por paso (ingeniería/administrativos/EPP)
5) Roles y responsables
6) Puntos de paro (“Stop Work”)
7) Confirmación del equipo (briefing)`,
      options: [
        { key: "1", label: "Ejemplo ATS", next: "ats_ejemplo" },
        { key: "2", label: "Volver a ATS", next: "ats" },
        { key: "3", label: "Menú principal", next: "home" }
      ],
      keywords: { "ejemplo": "ats_ejemplo", "ats": "ats", "inicio": "home" }
    },

    ats_ejemplo: {
      bot:
`Ejemplo (formato) ATS:
Tarea: Intervención en equipo.
Paso 1: Aislar energías → Peligro: energías peligrosas → Control: LOTO + verificación de energía cero.
Paso 2: Retiro/instalación → Peligro: atrapamiento/cortes → Control: herramientas adecuadas + guantes adecuados.
Paso 3: Prueba controlada → Peligro: arranque inesperado → Control: autorización + área despejada + comunicación.`,
      options: [
        { key: "1", label: "Volver a ATS", next: "ats" },
        { key: "2", label: "Menú principal", next: "home" }
      ],
      keywords: { "ats": "ats", "inicio": "home" }
    },

    peligros: {
      bot:
`Diferencia clave:
• Peligro: fuente con potencial de daño.
• Riesgo: probabilidad y consecuencia del daño.

Ejemplos:
• Peligro: trabajo en altura → Riesgo: caída con lesión grave
• Peligro: cable energizado → Riesgo: electrocución
• Peligro: polvo respirable → Riesgo: afectación respiratoria

Escribe una opción:`,
      options: [
        { key: "1", label: "Jerarquía de controles (priorización)", next: "jerarquia" },
        { key: "2", label: "Menú principal", next: "home" }
      ],
      keywords: { "jerarquia": "jerarquia", "controles": "jerarquia", "inicio": "home" }
    },

    jerarquia: {
      bot:
`Jerarquía de controles (mejor a peor):
1) Eliminación
2) Sustitución
3) Ingeniería (guardas, enclavamientos, barandas, ventilación)
4) Administrativos (procedimientos, señalización, permisos, capacitación)
5) EPP (última barrera)

Regla: si dependes solo del EPP, el control suele ser débil.`,
      options: [
        { key: "1", label: "Volver a Peligros/Riesgos", next: "peligros" },
        { key: "2", label: "Menú principal", next: "home" }
      ],
      keywords: { "peligros": "peligros", "inicio": "home" }
    },

    epp: {
      bot:
`EPP (Equipo de Protección Personal):
El EPP es la última barrera y debe seleccionarse según el riesgo.

Escribe una opción:`,
      options: [
        { key: "1", label: "Guía rápida de selección de EPP", next: "epp_seleccion" },
        { key: "2", label: "Checklist de inspección de EPP", next: "epp_checklist" },
        { key: "3", label: "Menú principal", next: "home" }
      ],
      keywords: { "seleccion": "epp_seleccion", "checklist": "epp_checklist", "inicio": "home" }
    },

    epp_seleccion: {
      bot:
`Selección rápida (guía):
• Ojos/cara: gafas/visor (proyección, partículas, químicos)
• Manos: guante según riesgo (anticorte, dieléctrico, químico)
• Respiratorio: filtro según contaminante (requiere ajuste/entrenamiento)
• Audición: tapones/orejeras (ruido)
• Altura: arnés + línea de vida + conectores certificados (si aplica)
• Pies: botas con puntera y suela según entorno

Si indicas la tarea, el bot te sugiere qué revisar (sin reemplazar al estándar interno).`,
      options: [
        { key: "1", label: "Checklist EPP", next: "epp_checklist" },
        { key: "2", label: "Volver a EPP", next: "epp" },
        { key: "3", label: "Menú principal", next: "home" }
      ],
      keywords: { "checklist": "epp_checklist", "epp": "epp", "inicio": "home" }
    },

    epp_checklist: {
      bot:
`Checklist EPP:
□ Sin cortes/roturas/deformaciones
□ Talla y ajuste correctos
□ Inspección vigente (si aplica)
□ Arnés/conectores sin desgaste
□ Respirador con sello y filtros correctos
□ Lentes sin rayaduras críticas
□ Limpieza y almacenamiento adecuados`,
      options: [
        { key: "1", label: "Volver a EPP", next: "epp" },
        { key: "2", label: "Menú principal", next: "home" }
      ],
      keywords: { "epp": "epp", "inicio": "home" }
    },

    alto_riesgo: {
      bot:
`Trabajos de Alto Riesgo:
Tareas con potencial severo (altura, energías peligrosas, izaje, espacios confinados, caliente, etc.).
Suelen requerir verificación de controles críticos y permisos según estándar de la operación.

Escribe una opción:`,
      options: [
        { key: "1", label: "PETAR (definición)", next: "petar" },
        { key: "2", label: "Checklist previo (alto riesgo)", next: "alto_riesgo_checklist" },
        { key: "3", label: "Menú principal", next: "home" }
      ],
      keywords: { "petar": "petar", "checklist": "alto_riesgo_checklist", "inicio": "home" }
    },

    petar: {
      bot:
`PETAR: Permiso Escrito de Trabajo de Alto Riesgo.
Documento que autoriza el trabajo de alto riesgo verificando:
• IPERC/ATS aplicado
• Controles críticos implementados
• Roles y autorizaciones definidas
• Condiciones de paro (“Stop Work”) claras
• Verificación previa y comunicación al equipo

Los requisitos exactos dependen del estándar interno vigente de la operación.`,
      options: [
        { key: "1", label: "Checklist alto riesgo", next: "alto_riesgo_checklist" },
        { key: "2", label: "Volver a Alto Riesgo", next: "alto_riesgo" },
        { key: "3", label: "Menú principal", next: "home" }
      ],
      keywords: { "checklist": "alto_riesgo_checklist", "inicio": "home" }
    },

    alto_riesgo_checklist: {
      bot:
`Checklist alto riesgo (previo):
□ Permisos requeridos completos (si aplica)
□ Energía controlada/aislada (cuando corresponda)
□ Señalización y control de área
□ Supervisión/roles claros
□ Equipos certificados/inspeccionados (arnés, eslingas, herramientas)
□ Comunicación efectiva y “Stop Work”
□ Condiciones ambientales aceptables
□ Plan de rescate/emergencia (si aplica)`,
      options: [
        { key: "1", label: "Volver a Alto Riesgo", next: "alto_riesgo" },
        { key: "2", label: "Menú principal", next: "home" }
      ],
      keywords: { "inicio": "home" }
    },

    loto: {
      bot:
`LOTO (Bloqueo y Etiquetado):
Método para controlar energías peligrosas y evitar arranques/liberaciones inesperadas.

Escribe una opción:`,
      options: [
        { key: "1", label: "Pasos LOTO (resumen)", next: "loto_pasos" },
        { key: "2", label: "Errores comunes", next: "loto_errores" },
        { key: "3", label: "Menú principal", next: "home" }
      ],
      keywords: { "pasos": "loto_pasos", "errores": "loto_errores", "inicio": "home" }
    },

    loto_pasos: {
      bot:
`Pasos LOTO (resumen):
1) Preparar y notificar
2) Parar el equipo
3) Aislar energía (eléctrica/neumática/hidráulica/gravedad)
4) Bloquear y etiquetar
5) Liberar energía residual
6) Verificar “energía cero”
7) Ejecutar trabajo
8) Retiro de bloqueo con autorización y prueba controlada`,
      options: [
        { key: "1", label: "Errores comunes LOTO", next: "loto_errores" },
        { key: "2", label: "Volver a LOTO", next: "loto" },
        { key: "3", label: "Menú principal", next: "home" }
      ],
      keywords: { "errores": "loto_errores", "inicio": "home" }
    },

    loto_errores: {
      bot:
`Errores comunes en LOTO:
• No verificar energía cero
• No identificar todas las fuentes (energías secundarias)
• Bloqueo compartido sin control por persona
• Retiro de bloqueo sin autorización
• Etiquetado incompleto o confuso`,
      options: [
        { key: "1", label: "Volver a LOTO", next: "loto" },
        { key: "2", label: "Menú principal", next: "home" }
      ],
      keywords: { "inicio": "home" }
    },

    incidentes: {
      bot:
`Incidentes (incluye cuasi-accidentes, condiciones/actos inseguros, daños menores):
El objetivo es aprender y prevenir recurrencias.

Escribe una opción:`,
      options: [
        { key: "1", label: "Qué hacer inmediatamente", next: "incidente_que_hacer" },
        { key: "2", label: "Cómo hacer un buen reporte", next: "incidente_buen_reporte" },
        { key: "3", label: "Menú principal", next: "home" }
      ],
      keywords: { "inmediato": "incidente_que_hacer", "reporte": "incidente_buen_reporte", "inicio": "home" }
    },

    incidente_que_hacer: {
      bot:
`Acción inmediata (guía):
1) Detén el trabajo si hay riesgo activo (“Stop Work”)
2) Asegura el área / controla el peligro
3) Notifica al supervisor / SST
4) Atiende a personas si aplica (primeros auxilios)
5) Conserva evidencias sin exponerte (fotos, hora, ubicación)
6) Reporta por el canal definido`,
      options: [
        { key: "1", label: "Cómo reportar mejor", next: "incidente_buen_reporte" },
        { key: "2", label: "Volver a Incidentes", next: "incidentes" },
        { key: "3", label: "Menú principal", next: "home" }
      ],
      keywords: { "reporte": "incidente_buen_reporte", "inicio": "home" }
    },

    incidente_buen_reporte: {
      bot:
`Buen reporte (estructura):
• Qué pasó (hechos, sin culpas)
• Dónde y cuándo
• Qué tarea se hacía
• Peligros y controles existentes
• Qué falló o qué cambió
• Acciones inmediatas
• Recomendaciones de control (prioriza ingeniería/administrativos)`,
      options: [
        { key: "1", label: "Volver a Incidentes", next: "incidentes" },
        { key: "2", label: "Menú principal", next: "home" }
      ],
      keywords: { "inicio": "home" }
    },

    contactos: {
      bot:
`Directorio de contactos de emergencia (ejemplo):
• Juan Gomez — Supervisor de seguridad (Empresa A) — Cel: 999 999 999
• Luis Chavez — Supervisor de seguridad (Empresa B) — Cel: 988 888 888
• Maria Torres — Paramédico / Tópico — Cel: 977 777 777
• Central de Emergencias (Operación) — Cel: 911 111 111

Si hay riesgo inmediato: detén el trabajo (“Stop Work”), aléjate del peligro y comunica.`,
      options: [
        { key: "1", label: "Menú principal", next: "home" },
        { key: "2", label: "Ver Glosario", next: "glosario" }
      ],
      keywords: { "inicio": "home", "glosario": "glosario" }
    },

    glosario: {
      bot:
`Glosario rápido:
• IPERC: Identificación de Peligros, Evaluación de Riesgos y Controles
• PETS: Procedimiento Escrito de Trabajo Seguro
• ATS/AST: Análisis Seguro de Trabajo
• PETAR: Permiso Escrito de Trabajo de Alto Riesgo
• LOTO: Bloqueo y Etiquetado

Escribe “inicio” para volver al menú principal.`,
      options: [
        { key: "1", label: "Menú principal", next: "home" }
      ],
      keywords: { "inicio": "home", "menu": "home" }
    }
  };

  // =========================
  // 2) Estado del chat
  // =========================
  let state = "home";
  const stack = []; // historial para "volver"

  const chatEl = document.getElementById("chat");
  const menuEl = document.getElementById("menu");
  const inputEl = document.getElementById("input");
  const sendBtn = document.getElementById("sendBtn");

  // =========================
  // 3) Utilidades
  // =========================
  function addBot(text){
    const row = document.createElement("div");
    row.className = "row bot";
    row.innerHTML = `<div class="bubble">${escapeHtml(text)}</div>`;
    chatEl.appendChild(row);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function addUser(text){
    const row = document.createElement("div");
    row.className = "row user";
    row.innerHTML = `<div class="bubble">${escapeHtml(text)}</div>`;
    chatEl.appendChild(row);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function normalize(s){
    // minúsculas + quitar tildes + trim + colapsar espacios
    return String(s || "")
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, " ")
      .trim();
  }

  function renderMenu(){
    const node = KB[state];
    const lines = node.options.map(o => `${o.key}. ${o.label}`).join("\n");
    menuEl.textContent = lines;
  }

  function goto(next){
    if (!KB[next]) {
      addBot("No tengo esa opción configurada. Escribe 'inicio' para volver al menú principal.");
      return;
    }
    stack.push(state);
    state = next;
    addBot(KB[state].bot);
    renderMenu();
  }

  function resolveInput(userRaw){
    const user = normalize(userRaw);
    const node = KB[state];

    // Comandos globales
    if (["inicio","menu","menú","home"].includes(user)) return { type:"goto", next:"home", label:"Inicio" };
    if (["volver","atras","atrás","back"].includes(user)) return { type:"back", label:"Volver" };
    if (["contactos","emergencia","contacto"].includes(user)) return { type:"goto", next:"contactos", label:"Contactos de emergencia" };
    if (["glosario"].includes(user)) return { type:"goto", next:"glosario", label:"Glosario" };

    // Si el usuario escribe exactamente un número (opción)
    const optByNumber = node.options.find(o => o.key === user);
    if (optByNumber) return { type:"goto", next: optByNumber.next, label: optByNumber.label };

    // Palabras clave del nodo actual
    if (node.keywords) {
      // match exacto
      if (node.keywords[user]) return { type:"goto", next: node.keywords[user], label: userRaw };

      // match parcial: si el input contiene alguna keyword
      for (const k of Object.keys(node.keywords)) {
        if (k.length >= 3 && user.includes(k)) {
          return { type:"goto", next: node.keywords[k], label: userRaw };
        }
      }
    }

    // Fallback: si estás en home, intenta keywords globales del home
    if (state !== "home") {
      const homeKw = KB.home.keywords || {};
      if (homeKw[user]) return { type:"goto", next: homeKw[user], label: userRaw };
      for (const k of Object.keys(homeKw)) {
        if (k.length >= 3 && user.includes(k)) {
          return { type:"goto", next: homeKw[k], label: userRaw };
        }
      }
    }

    return { type:"unknown" };
  }

  function helpUnknown(){
    addBot(
`No entendí tu respuesta.
Puedes:
• Escribir el número de una opción (ej. 1, 2, 3)
• Escribir una palabra clave (ej. iperc, pets, ats, epp, petar, loto)
• Escribir “inicio” para volver al menú principal o “contactos” para el directorio.`
    );
  }

  // =========================
  // 4) Acciones UI
  // =========================
  function goHome(){
    addUser("Inicio");
    state = "home";
    stack.length = 0;
    addBot(KB[state].bot);
    renderMenu();
    inputEl.focus();
  }

  function goBack(){
    if (stack.length === 0) {
      addBot("Ya estás en el menú principal. Escribe 1–9 o una palabra clave.");
      return;
    }
    addUser("Volver");
    state = stack.pop();
    addBot(KB[state].bot);
    renderMenu();
    inputEl.focus();
  }

  function jumpTo(id){
    addUser(id === "contactos" ? "Contactos" : "Glosario");
    state = id;
    addBot(KB[state].bot);
    renderMenu();
    inputEl.focus();
  }

  async function send(){
    const text = inputEl.value.trim();
    if (!text) return;

    addUser(text);
    inputEl.value = "";

    const res = resolveInput(text);

    if (res.type === "back") {
      goBack();
      return;
    }
    if (res.type === "goto") {
      state = res.next;
      addBot(KB[state].bot);
      renderMenu();
      inputEl.focus();
      return;
    }
    helpUnknown();
    inputEl.focus();
  }

  // Enter para enviar
  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      send();
    }
  });

  // =========================
  // 5) Inicio
  // =========================
  addBot(KB[state].bot);
  renderMenu();
  inputEl.focus();
</script>
</body>
</html>
